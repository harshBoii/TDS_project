import { Config, Message, Tool, EmbeddingRequests, ChatResponse, EmbeddingResponse, PartialChatResponse, GatewayBaseError } from '@adaline/types';
import { trace, metrics, context, SpanStatusCode } from '@opentelemetry/api';
import { v4 } from 'uuid';
import { z } from 'zod';
import { ATTR_HTTP_REQUEST_METHOD, ATTR_URL_FULL } from '@opentelemetry/semantic-conventions';
import le from 'axios';
import Mt from 'crypto-js/sha256.js';
import { LRUCache } from 'lru-cache';
import Ae from 'os';

var gt=Object.defineProperty,Rt=Object.defineProperties;var Tt=Object.getOwnPropertyDescriptors;var ge=Object.getOwnPropertySymbols;var wt=Object.prototype.hasOwnProperty,xt=Object.prototype.propertyIsEnumerable;var Z=(s,t)=>(t=Symbol[s])?t:Symbol.for("Symbol."+s),Et=s=>{throw TypeError(s)};var Re=(s,t,a)=>t in s?gt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a,T=(s,t)=>{for(var a in t||(t={}))wt.call(t,a)&&Re(s,a,t[a]);if(ge)for(var a of ge(t))xt.call(t,a)&&Re(s,a,t[a]);return s},M=(s,t)=>Rt(s,Tt(t));var vt=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(t,a)=>(typeof require!="undefined"?require:t)[a]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});var l=(s,t,a)=>new Promise((e,d)=>{var r=m=>{try{i(a.next(m));}catch(n){d(n);}},o=m=>{try{i(a.throw(m));}catch(n){d(n);}},i=m=>m.done?e(m.value):Promise.resolve(m.value).then(r,o);i((a=a.apply(s,t)).next());}),b=function(s,t){this[0]=s,this[1]=t;},Q=(s,t,a)=>{var e=(o,i,m,n)=>{try{var c=a[o](i),p=(i=c.value)instanceof b,y=c.done;Promise.resolve(p?i[0]:i).then(f=>p?e(o==="return"?o:"next",i[1]?{done:f.done,value:f.value}:f,m,n):m({value:f,done:y})).catch(f=>e("throw",f,m,n));}catch(f){n(f);}},d=o=>r[o]=i=>new Promise((m,n)=>e(o,i,m,n)),r={};return a=a.apply(s,t),r[Z("asyncIterator")]=()=>r,d("next"),d("throw"),d("return"),r},I=s=>{var t=s[Z("asyncIterator")],a=!1,e,d={};return t==null?(t=s[Z("iterator")](),e=r=>d[r]=o=>t[r](o)):(t=t.call(s),e=r=>d[r]=o=>{if(a){if(a=!1,r==="throw")throw o;return o}return a=!0,{done:!1,value:new b(new Promise(i=>{var m=t[r](o);m instanceof Object||Et("Object expected"),i(m);}),1)}}),d[Z("iterator")]=()=>d,e("next"),"throw"in t?e("throw"):d.throw=r=>{throw r},"return"in t&&e("return"),d},N=(s,t,a)=>(t=s[Z("asyncIterator")])?t.call(s):(s=s[Z("iterator")](),t={},a=(e,d)=>(d=s[e])&&(t[e]=r=>new Promise((o,i,m)=>(r=d.call(s,r),m=r.done,Promise.resolve(r.value).then(n=>o({value:n,done:m}),i)))),a("next"),a("return"),t);var g=class s extends Error{constructor(t,a=500,e){super(t),this.name="GatewayError",this.status=a,this.data=e,Error.captureStackTrace&&Error.captureStackTrace(this,s);}},qt="GatewayTelemetryError",Te=class s extends GatewayBaseError{constructor({info:t,cause:a}){super({info:t,cause:a},qt),this.info=t,this.cause=a,Object.setPrototypeOf(this,new.target.prototype);}static isGatewayTelemetryError(t){return t instanceof s}};var kt="HttpClientError",B=class s extends GatewayBaseError{constructor({info:t,cause:a}){super({info:t,cause:a},kt),this.info=t,this.cause=a,Object.setPrototypeOf(this,new.target.prototype);}static isHttpClientError(t){return t instanceof s}},St="HttpRequestError",w=class s extends GatewayBaseError{constructor(t,a=500,e,d){super({info:t,cause:{status:a,headers:e,data:d}},St),this.info=t,this.cause={status:a,headers:e,data:d},Object.setPrototypeOf(this,new.target.prototype);}static isHttpRequestError(t){return t instanceof s}};var R=class{static setTracer(t){this.tracer||(this.tracer=t||trace.getTracer(this.DEFAULT_TRACER_KEY));}static getTracer(){return this.tracer||trace.getTracer(this.DEFAULT_TRACER_KEY)}static setMeter(t){this.meter||(this.meter=t||metrics.getMeter(this.DEFAULT_METER_KEY));}static getMeter(){return this.meter||metrics.getMeter(this.DEFAULT_METER_KEY)}};R.DEFAULT_TRACER_KEY="gateway",R.DEFAULT_METER_KEY="gateway",R.tracer=void 0,R.meter=void 0;var ae=s=>{let t={};return s&&(typeof s=="object"||s instanceof Headers)&&Object.entries(s).forEach(([a,e])=>{Array.isArray(e)?t[a]=e.join(", "):typeof e=="string"?t[a]=e:t[a]="";}),t},ke=s=>{var r,o,i;let t=(s==null?void 0:s.message)||"An unexpected error occurred",a=((r=s==null?void 0:s.response)==null?void 0:r.status)||500,e=ae((o=s==null?void 0:s.response)==null?void 0:o.headers)||{},d=((i=s==null?void 0:s.response)==null?void 0:i.data)||{};return new w(t,a,e,d)},re=class{constructor(t){this.isNodeEnvironment=()=>typeof process!="undefined"&&process.versions!=null&&process.versions.node!=null;let{axiosInstance:a,timeoutInMilliseconds:e,enableProxyAgent:d}=t;this.client=a||le.create();let r=z.number().int().positive().optional();if(this.defaultTimeout=r.parse(e),this.client.defaults.timeout=this.defaultTimeout,this.enableProxyAgent=d!=null?d:!0,this.enableProxyAgent){let i=vt("proxy-agent");this.httpProxyAgent=new i.ProxyAgent,this.httpsProxyAgent=new i.ProxyAgent({rejectUnauthorized:!1});}let o=h.getLogger();o==null||o.debug(`IsomorphicHttpClient initialized with defaultTimeout: ${this.defaultTimeout}`);}makeRequest(o,i,m){return l(this,arguments,function*(t,a,e,d={},r){let n=h.getLogger(),c=p=>l(this,null,function*(){try{let y=T(M(T(T({},t==="get"||t==="delete"?{params:e}:{data:e}),d),{timeout:this.defaultTimeout}),this.enableProxyAgent?{httpAgent:this.httpProxyAgent,httpsAgent:this.httpsProxyAgent}:{});if(t==="get"||t==="delete"){let f=yield this.client[t](a,y);p==null||p.setStatus({code:SpanStatusCode.OK,message:"request successful"});let U={data:f.data,headers:ae(f.headers),status:{code:f.status,text:f.statusText}};return n==null||n.debug("IsomorphicHttpClient.makeRequest response: ",U),U}else {let f=yield this.client[t](a,y.data,M(T({},y),{params:y.params}));p==null||p.setStatus({code:SpanStatusCode.OK,message:"request successful"});let U={data:f.data,headers:ae(f.headers),status:{code:f.status,text:f.statusText}};return n==null||n.debug("IsomorphicHttpClient.makeRequest response: ",U),U}}catch(y){throw n==null||n.warn("IsomorphicHttpClient.makeRequest error: ",y),p==null||p.setStatus({code:SpanStatusCode.ERROR,message:"request failed"}),le.isAxiosError(y)?ke(y):new B({info:"An unexpected error occurred",cause:y})}finally{p==null||p.end();}});return r?yield context.with(r,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("http.request",y=>l(this,null,function*(){return y.setAttribute(ATTR_HTTP_REQUEST_METHOD,t.toUpperCase()),y.setAttribute(ATTR_URL_FULL,a),yield c(y)}))})):c()})}stream(t,a,e,d,r,o){return Q(this,null,function*(){let i=h.getLogger();i==null||i.debug(`IsomorphicHttpClient.STREAM request to ${t}`,{data:e,headers:d});let m=function(n){return Q(this,null,function*(){let c=Date.now(),p=!1;try{if(this.isNodeEnvironment()){i==null||i.debug("IsomorphicHttpClient.stream in node environment");let C=yield new b(this.client.request({method:a,url:t,headers:d,data:e,responseType:"stream",signal:r==null?void 0:r.abortSignal}));try{for(var y=N(C.data),f,U,O;f=!(U=yield new b(y.next())).done;f=!1){let j=U.value;if(!p){let S=Date.now()-c;n==null||n.setAttribute("time-to-first-token",S),p=!0;}n==null||n.addEvent("stream.chunk",{message:"stream chunk received"});let J=j.toString();i==null||i.debug("IsomorphicHttpClient.stream chunk: ",J),yield J;}}catch(U){O=[U];}finally{try{f&&(U=y.return)&&(yield new b(U.call(y)));}finally{if(O)throw O[0]}}n==null||n.setStatus({code:SpanStatusCode.OK,message:"stream successful"});}else {i==null||i.debug("IsomorphicHttpClient.stream in browser environment");let C={method:a,headers:new Headers(T({},d)),body:a!=="get"?JSON.stringify(e):void 0,signal:r==null?void 0:r.abortSignal},j=yield new b(fetch(t,C));if(!j.ok){i==null||i.warn("IsomorphicHttpClient.stream response not ok: ",j),n==null||n.setStatus({code:SpanStatusCode.ERROR,message:"stream failed"});let J=yield new b(j.json());throw new w(`Request failed with status ${j.status}`,j.status,ae(j.headers),J)}if(j.body){let J=j.body.getReader();for(;;){let{done:S,value:F}=yield new b(J.read());if(S){if(!p&&F){let V=Date.now()-c;n==null||n.setAttribute("time-to-first-token",V),p=!0;}n==null||n.addEvent("stream.chunk",{message:"stream chunk received"});let q=new TextDecoder().decode(F,{stream:!0});i==null||i.debug("IsomorphicHttpClient.stream chunk: ",q),yield q;break}if(!p){let q=Date.now()-c;n==null||n.setAttribute("time-to-first-token",q),p=!0;}n==null||n.addEvent("stream.chunk",{message:"stream chunk received"});let x=new TextDecoder().decode(F,{stream:!0});i==null||i.debug("IsomorphicHttpClient.stream chunk: ",x),yield x;}n==null||n.setStatus({code:SpanStatusCode.OK,message:"stream successful"});}else throw i==null||i.warn("IsomorphicHttpClient.stream response has no body"),n==null||n.setStatus({code:SpanStatusCode.ERROR,message:"stream failed"}),new w("Cannot stream the body of the response.",500,{},j)}}catch(C){throw i==null||i.warn("IsomorphicHttpClient.stream error: ",C),n==null||n.setStatus({code:SpanStatusCode.ERROR,message:"stream failed"}),w.isHttpRequestError(C)?C:(C==null?void 0:C.name)==="AbortError"?new w("AbortError",408,{},{}):(C==null?void 0:C.name)==="CanceledError"?new w("AbortError",408,{},{}):le.isAxiosError(C)?ke(C):new B({info:"An unexpected error occurred",cause:C})}finally{n==null||n.end();}})}.bind(this);return o?yield*I(yield new b(context.with(o,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("http.stream",c=>l(this,null,function*(){return c.setAttribute(ATTR_HTTP_REQUEST_METHOD,a.toUpperCase()),c.setAttribute(ATTR_URL_FULL,t),yield m(c)}))})))):yield*I(m())})}get(t,a,e,d){return l(this,null,function*(){let r=h.getLogger();return r==null||r.debug(`IsomorphicHttpClient.GET request to ${t}`,{params:a,headers:e}),this.makeRequest("get",t,a||{},{headers:e},d)})}post(t,a,e,d){return l(this,null,function*(){let r=h.getLogger();return r==null||r.debug(`IsomorphicHttpClient.POST request to ${t}`,{data:a,headers:e}),this.makeRequest("post",t,a||{},{headers:e},d)})}put(t,a,e,d){return l(this,null,function*(){let r=h.getLogger();return r==null||r.debug(`IsomorphicHttpClient.PUT request to ${t}`,{data:a,headers:e}),this.makeRequest("put",t,a||{},{headers:e},d)})}delete(t,a,e,d){return l(this,null,function*(){let r=h.getLogger();return r==null||r.debug(`IsomorphicHttpClient.DELETE request to ${t}`,{params:a,headers:e}),this.makeRequest("delete",t,a||{},{headers:e},d)})}patch(t,a,e,d){return l(this,null,function*(){let r=h.getLogger();return r==null||r.debug(`IsomorphicHttpClient.PATCH request to ${t}`,{data:a,headers:e}),this.makeRequest("patch",t,a||{},{headers:e},d)})}};var At="QueueTaskTimeoutError",oe=class s extends GatewayBaseError{constructor({info:t,cause:a}){super({info:t,cause:a},At),this.info=t,this.cause=a,Object.setPrototypeOf(this,new.target.prototype);}static isQueueTaskTimeoutError(t){return t instanceof s}};var Se=z.object({maxConcurrentTasks:z.number().int().positive(),retryCount:z.number().int().positive(),timeout:z.number().int().positive(),retry:z.object({initialDelay:z.number().int().positive(),exponentialFactor:z.number().int().positive()})});var se=(s,t)=>Mt(s+JSON.stringify(t)).toString(),$=s=>s instanceof g?s:B.isHttpClientError(s)?new g(s.message):s instanceof Error?new g(s.message):new g(s),v=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined";var Lt={error:"color: red",warn:"color: yellow",info:"color: green"},Ut=(s,t,...a)=>{if(v())v()&&console.log(`%c[${s.toUpperCase()}] [${t}]`,Lt[s],...a);else switch(s){case"error":console.error(...a);break;case"warn":console.warn(...a);break;default:console.log(...a);}},Ot=(s,t,...a)=>{var e;v()||((e=process==null?void 0:process.env)==null?void 0:e.DEBUG)==="true"&&Ut(s,t,...a);},L=(s,t,...a)=>l(void 0,null,function*(){let e=[];s.forEach(d=>{let r=d[t];if(typeof r=="function")try{let o=r(...a);o instanceof Promise&&e.push(o);}catch(o){Ot("error",`SAFELY_INVOKE_CALLBACKS:${String(t)}:`,o);}}),yield Promise.allSettled(e);}),He=s=>new Promise(t=>setTimeout(t,s));var h=class{static setLogger(t){this.logger=t;}static getLogger(){return this.logger}};var Pe=class{debug(t,...a){console.debug(t,...a);}info(t,...a){console.info(t,...a);}warn(t,...a){v()?console.warn(`%WARN: %c${t}`,"color: yellow; font-weight: bold;","",...a):console.warn(`\x1B[33mWARN:\x1B[0m ${t}`,...a);}error(t,...a){v()?console.error(`%ERROR: %c${t}`,"color: lightcoral; font-weight: bold;","",...a):console.error(`\x1B[91mERROR:\x1B[0m ${t}`,...a);}critical(t,...a){v()?console.error(`%cCRITICAL: %c${t}`,"color: red; font-weight: bold;","",...a):console.error(`\x1B[31;1mCRITICAL:\x1B[0m ${t}`,...a);}};var Y=class{constructor(t){this.activeTasks=0;this.queue=[];this.options=t;}enqueue(t){let a=h.getLogger();a==null||a.debug(`SimpleQueue.enqueue invoked, id: ${t.id}`),context.with(t.telemetryContext,()=>l(this,null,function*(){return R.getTracer().startActiveSpan("queue.task.pickup-wait",d=>l(this,null,function*(){d.setAttribute("id",t.id),this.queue.push({task:t,taskSpan:d}),a==null||a.debug(`SimpleQueue.enqueue task enqueued, id: ${t.id}`);}))})),this.processQueue();}executeWithTimeout(t,a){let e=h.getLogger();return e==null||e.debug(`SimpleQueue.executeWithTimeout invoked with timeout: ${this.options.timeout}, id: ${t.id}`),new Promise((d,r)=>{let o=setTimeout(()=>{e==null||e.warn(`SimpleQueue.executeWithTimeout timed out, id: ${t.id}`),r(new oe({info:"Queue task timeout",cause:new Error("Queue task timeout")}));},this.options.timeout);e==null||e.debug(`SimpleQueue.executeWithTimeout task executing, id: ${t.id}`),t.execute(t.request,a).then(i=>{e==null||e.debug(`SimpleQueue.executeWithTimeout task completed, id: ${t.id}`),clearTimeout(o),d(i);}).catch(i=>{e==null||e.warn(`SimpleQueue.executeWithTimeout task errored, id: ${t.id}`),clearTimeout(o),r(i);});})}executeWithRetry(t,a){return l(this,null,function*(){let e=h.getLogger();return yield context.with(t.telemetryContext,()=>l(this,null,function*(){let d=R.getTracer();return yield d.startActiveSpan("queue.task.execute",r=>l(this,null,function*(){e==null||e.debug(`SimpleQueue.executeWithRetry invoked, attempt: ${this.options.retryCount-a}, id: ${t.id}`),r.setAttribute("attempt",this.options.retryCount-a);try{let o=context.active(),i=yield this.executeWithTimeout(t,o);return r.setStatus({code:SpanStatusCode.OK}),r.end(),i}catch(o){if(a===0)throw e==null||e.warn(`SimpleQueue.executeWithRetry retry count reached, id: ${t.id}`),r.end(),o;let i=!0,m=this.options.retry.initialDelay*Math.pow(this.options.retry.exponentialFactor,this.options.retryCount-a);if(w.isHttpRequestError(o)){if(o.cause.status===429){e==null||e.warn(`SimpleQueue.executeWithRetry rate limiting error, id: ${t.id}`);let n=ee.safeParse(t.request);if(n.success){let c=n.data.model.getRetryDelay(o.cause.headers);i=c.shouldRetry,c.delayMs>0&&(m=c.delayMs);}}o.cause.status>=500&&o.cause.status<600&&(e==null||e.warn(`SimpleQueue.executeWithRetry ${o.cause.status} error, id: ${t.id}`));}else e==null||e.warn(`SimpleQueue.executeWithRetry non http-request error, id: ${t.id}`,{error:o});if(i)return yield d.startActiveSpan("queue.task.retry-wait",n=>l(this,null,function*(){return e==null||e.debug(`SimpleQueue.executeWithRetry retry wait: ${m}ms, id: ${t.id}`),yield He(m),n.end(),r.end(),this.executeWithRetry(t,a-1)}));throw e==null||e.warn(`SimpleQueue.executeWithRetry model returned should not retry, id: ${t.id}`),r.end(),o}finally{}}))}))})}processQueue(){return l(this,null,function*(){var r;let t=h.getLogger();if(this.activeTasks>=this.options.maxConcurrentTasks){t==null||t.debug("SimpleQueue.processQueue max concurrent tasks reached");return}let a=this.queue.shift();if(!a){t==null||t.debug("SimpleQueue.processQueue no item to process");return}let{task:e,taskSpan:d}=a;d&&d.end(),this.activeTasks+=1,t==null||t.debug(`SimpleQueue.processQueue active tasks: ${this.activeTasks}`),t==null||t.debug(`SimpleQueue.processQueue processing task, id: ${e.id}`);try{let o=yield this.executeWithRetry(e,this.options.retryCount);t==null||t.debug(`SimpleQueue.processQueue task completed, id: ${e.id}`),e.resolve(o);}catch(o){t==null||t.warn(`SimpleQueue.processQueue task errored, id: ${e.id}`),e.reject(o);}finally{this.activeTasks-=1,t==null||t.debug(`SimpleQueue.processQueue active tasks: ${this.activeTasks}`),(r=trace.getSpan(e.telemetryContext))==null||r.end(),this.processQueue();}})}};var te=class{constructor(t=1e3){this.cache=new LRUCache({max:t,allowStale:!1,updateAgeOnGet:!1});let a=h.getLogger();a==null||a.debug(`LRUCache initialized with maxEntries: ${t}`);}get(t){return l(this,null,function*(){let a=h.getLogger();return a==null||a.debug(`LRUCache.get invoked, key: ${t}`),new Promise(e=>{let d=this.cache.get(t);a==null||a.debug("LRUCache.get completed, value: ",d),e(d);})})}set(t,a){return l(this,null,function*(){let e=h.getLogger();return e==null||e.debug(`LRUCache.set invoked, key: ${t}, value: `,a),new Promise(d=>{this.cache.set(t,a),e==null||e.debug("LRUCache.set completed"),d();})})}delete(t){return l(this,null,function*(){let a=h.getLogger();return a==null||a.debug(`LRUCache.delete invoked, key: ${t}`),new Promise(e=>{this.cache.delete(t),a==null||a.debug("LRUCache.delete completed"),e();})})}clear(){return l(this,null,function*(){let t=h.getLogger();return t==null||t.debug("LRUCache.clear invoked"),new Promise(a=>{this.cache.clear(),t==null||t.debug("LRUCache.clear completed"),a();})})}};var ne=class{record(t,a,e){}stopRecorder(){}};var Me=()=>({node:{version:process.version,platform:Ae.platform(),architecture:Ae.arch()}}),Le=()=>({browser:{version:navigator.userAgent,userAgent:navigator.userAgent}});var ie=class{constructor(){this.eventVersion="0.1";this.gatewayVersion="1.2.0";this.flushInterval=1e4;this.batchSize=1;this.maxAttempts=3;this.environment=v()?Le():Me();this.analyticsEndpointUrl="https://j954t34pkh.execute-api.us-east-1.amazonaws.com/v0/analytics";this.events=[];}startFlushTimer(){v()?this.flushTimer=window.setInterval(()=>this.flushEvents(),this.flushInterval):this.flushTimer=setInterval(()=>this.flushEvents(),this.flushInterval);}stopFlushTimer(){v()?window.clearInterval(this.flushTimer):clearInterval(this.flushTimer);}record(t,a,e){let d={event:t,status:a,dimensions:e,timestamp:new Date().toISOString(),eventVersion:this.eventVersion,gatewayVersion:this.gatewayVersion,environment:this.environment};this.events.push({event:d,attempt:0}),this.events.length>=this.batchSize&&this.flushEvents();}flushEvents(){return l(this,null,function*(){if(this.events.length===0)return;let t=[...this.events];this.events=[],(yield this.sendEvents(t.map(e=>e.event)))||this.events.push(...t.filter(e=>e.attempt<this.maxAttempts).map(e=>({event:e.event,attempt:e.attempt+1})));})}sendEvents(t){return l(this,null,function*(){try{return (yield le.post(this.analyticsEndpointUrl,{events:t},{headers:{"Content-Type":"application/json"}})).status===200}catch(a){return !1}})}stopRecorder(){this.stopFlushTimer(),this.flushEvents();}};var de=class{static getAnalyticsRecorder(t){return this.analytics!==void 0?this.analytics:(this.analytics=t?new ie:new ne,this.analytics)}};var Qe=z.object({queueOptions:z.lazy(()=>Se.partial()).optional(),dangerouslyAllowBrowser:z.boolean().optional(),httpClient:z.custom().optional(),completeChatCache:z.custom().optional(),completeChatCallbacks:z.array(z.custom()).nonempty().optional(),getEmbeddingsCache:z.custom().optional(),getEmbeddingsCallbacks:z.array(z.custom()).nonempty().optional(),streamChatCallbacks:z.array(z.custom()).nonempty().optional(),logger:z.custom().optional(),telemetry:z.object({tracer:z.custom().optional(),meter:z.custom().optional()}).optional(),enableAnalytics:z.boolean().optional(),enableProxyAgent:z.boolean().optional()}),zt=z.object({enableCache:z.boolean().optional().default(!0),customHeaders:z.record(z.string()).optional(),metadataForCallbacks:z.any().optional()}),ee=z.object({model:z.custom(),config:Config(),messages:z.array(Message()),tools:z.array(Tool()).optional(),options:zt.optional()}),Dt=z.object({customHeaders:z.record(z.string()).optional(),metadataForCallbacks:z.any().optional()}),Ie=z.object({model:z.custom(),config:Config(),messages:z.array(Message()),tools:z.array(Tool()).optional(),options:Dt.optional(),abortSignal:z.instanceof(AbortSignal).optional()}),Vt=z.object({enableCache:z.boolean().optional().default(!0),customHeaders:z.record(z.string()).optional(),metadataForCallbacks:z.any().optional()}),he=z.object({model:z.custom(),config:Config(),embeddingRequests:EmbeddingRequests(),options:Vt.optional()}),Ce=z.object({model:z.custom(),data:z.any(),headers:z.record(z.string()),query:z.record(z.string()).optional()}),$e=z.object({model:z.custom(),data:z.any(),headers:z.record(z.string()),query:z.record(z.string()).optional()}),fe=z.object({model:z.custom(),data:z.any(),headers:z.record(z.string()),query:z.record(z.string()).optional()}),je=z.object({chatUsage:z.custom(),chatModelPrice:z.custom().optional(),model:z.custom().optional()}).refine(s=>s.chatModelPrice!==void 0!=(s.model!==void 0),{message:"Exactly one of chatModelPrice or model must be provided, not both.",path:["chatModelPrice","model"]});var Ve=z.object({cache:z.custom(),model:z.custom(),config:Config(),messages:z.array(Message()),tools:z.array(Tool()).optional(),enableCache:z.boolean(),customHeaders:z.record(z.string()).optional(),callbacks:z.array(z.custom()).nonempty().optional(),metadataForCallbacks:z.any().optional()}),Rr=z.object({request:z.object({config:Config(),messages:z.array(Message()),tools:z.array(Tool()).optional()}),response:ChatResponse,cached:z.boolean(),latencyInMs:z.number().int().positive(),metadataForCallbacks:z.any().optional(),provider:z.object({request:z.any(),response:z.any()})});function Ke(s,t,a){return l(this,null,function*(){let e=h.getLogger(),d=r=>l(this,null,function*(){e==null||e.debug("handleCompleteChat invoked"),e==null||e.debug("handleCompleteChat request: ",{request:s});let o=Ve.parse(s),i=s.callbacks||[],m=context.active();try{L(i,"onChatStart",s.metadataForCallbacks);let n={config:o.config,messages:o.messages,tools:o.tools},c={url:yield o.model.getCompleteChatUrl(o.config,o.messages,o.tools),headers:yield o.model.getCompleteChatHeaders(o.config,o.messages,o.tools),data:yield o.model.getCompleteChatData(o.config,o.messages,o.tools)};v()||(c.headers=M(T({},c.headers),{source:"adaline.ai"})),o.customHeaders&&(c.headers=T(T({},c.headers),o.customHeaders)),e==null||e.debug("handleCompleteChat providerRequest: ",{providerRequest:c});let p=se(`complete-chat:${c.url}:${o.model.modelSchema.name}`,n);if(o.enableCache){e==null||e.debug("handleCompleteChat checking cache");let C=yield s.cache.get(p);if(C)return C.cached=!0,e==null||e.debug("handleCompleteChat cached hit"),r==null||r.setAttribute("cached",!0),r==null||r.setStatus({code:SpanStatusCode.OK}),L(i,"onChatCached",s.metadataForCallbacks,C),e==null||e.debug("handleCompleteChat cached response: ",{cachedResponse:C}),C}e==null||e.debug("handleCompleteChat cache miss");let y=Date.now(),f=yield t.post(c.url,c.data,c.headers,m),U=Date.now()-y;e==null||e.debug("handleCompleteChat providerResponse: ",{providerResponse:f});let O={request:n,response:o.model.transformCompleteChatResponse(f.data),cached:!1,latencyInMs:U,metadataForCallbacks:s.metadataForCallbacks,provider:{request:c,response:f}};return e==null||e.debug("handleCompleteChat response: ",{response:O}),o.enableCache&&(yield s.cache.set(p,O),e==null||e.debug("handleCompleteChat response cached")),r==null||r.setAttribute("cached",!1),r==null||r.setStatus({code:SpanStatusCode.OK}),L(i,"onChatComplete",s.metadataForCallbacks,O),O}catch(n){e==null||e.warn("handleCompleteChat error: ",{error:n});let c;throw w.isHttpRequestError(n)||n instanceof g?c=n:c=$(n),L(i,"onChatError",s.metadataForCallbacks,c),c}finally{r==null||r.end();}});return a?yield context.with(a,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("complete-chat.handler",o=>l(this,null,function*(){return yield d(o)}))})):yield d()})}function Be(s){let{promptTokens:t,completionTokens:a}=s.chatUsage,e;if(s.chatModelPrice)e=s.chatModelPrice;else if(s.model)e=s.model.getModelPricing();else throw new g("No chatModelPrice or model provided");function d(c,p){var U,O;let y=e.tokenRanges.find(C=>c>=C.minTokens&&(C.maxTokens===null||C.maxTokens===void 0||c<C.maxTokens));if(!y)throw new g("Unable to find a pricing tier for the given token count. Please check your model pricing configuration.");let f=(O=(U=y.prices)==null?void 0:U.base)==null?void 0:O[p];if(f===void 0)throw new g("Unable to find a pricing rate for the given token count. Please check your model pricing configuration.");return f}let r=d(t,"inputPricePerMillion"),o=d(t,"outputPricePerMillion"),i=Number((t/1e6*r).toFixed(6)),m=Number((a/1e6*o).toFixed(6));return {cost:i+m,currency:e.currency||"USD",pricingModel:e,usageTokens:s.chatUsage}}var Je=z.object({cache:z.custom(),model:z.custom(),config:Config(),embeddingRequests:EmbeddingRequests(),enableCache:z.boolean(),customHeaders:z.record(z.string()).optional(),callbacks:z.array(z.custom()).nonempty().optional(),metadataForCallbacks:z.any().optional()}),$r=z.object({request:z.object({config:Config(),embeddingRequests:EmbeddingRequests()}),response:EmbeddingResponse,cached:z.boolean(),latencyInMs:z.number().int().positive(),metadataForCallbacks:z.any().optional(),provider:z.object({request:z.any(),response:z.any()})});function et(s,t,a){return l(this,null,function*(){let e=h.getLogger(),d=r=>l(this,null,function*(){e==null||e.debug("handleGetEmbeddings invoked"),e==null||e.debug("handleGetEmbeddings request: ",{request:s});let o=Je.parse(s),i=s.callbacks||[],m=context.active();try{L(i,"onGetEmbeddingsStart",s.metadataForCallbacks);let n={config:o.config,embeddingRequests:o.embeddingRequests},c={url:yield o.model.getGetEmbeddingsUrl(o.config,o.embeddingRequests),headers:yield o.model.getGetEmbeddingsHeaders(o.config,o.embeddingRequests),data:yield o.model.getGetEmbeddingsData(o.config,o.embeddingRequests)};v()||(c.headers=M(T({},c.headers),{source:"adaline.ai"})),o.customHeaders&&(c.headers=T(T({},c.headers),o.customHeaders)),e==null||e.debug("handleGetEmbeddings providerRequest: ",{providerRequest:c});let p=se(`get-embeddings:${c.url}:${o.model.modelSchema.name}`,n);if(o.enableCache){e==null||e.debug("handleGetEmbeddings checking cache");let C=yield s.cache.get(p);if(C)return C.cached=!0,e==null||e.debug("handleGetEmbeddings cached hit"),r==null||r.setAttribute("cached",!0),r==null||r.setStatus({code:SpanStatusCode.OK}),L(i,"onGetEmbeddingsCached",s.metadataForCallbacks,C),e==null||e.debug("handleGetEmbeddings cached response: ",{cachedResponse:C}),C}e==null||e.debug("handleGetEmbeddings cache miss");let y=Date.now(),f=yield t.post(c.url,c.data,c.headers,m),U=Date.now()-y;e==null||e.debug("handleGetEmbeddings providerResponse: ",{providerResponse:f});let O={request:n,response:o.model.transformGetEmbeddingsResponse(f.data),cached:!1,latencyInMs:U,metadataForCallbacks:s.metadataForCallbacks,provider:{request:c,response:f}};return e==null||e.debug("handleGetEmbeddings response: ",{response:O}),o.enableCache&&(yield s.cache.set(p,O),e==null||e.debug("handleGetEmbeddings response cached")),r==null||r.setAttribute("cached",!1),r==null||r.setStatus({code:SpanStatusCode.OK}),L(i,"onGetEmbeddingsComplete",s.metadataForCallbacks,O),O}catch(n){e==null||e.warn("handleGetEmbeddings error: ",{error:n});let c;throw w.isHttpRequestError(n)||n instanceof g?c=n:c=$(n),L(i,"onGetEmbeddingsError",s.metadataForCallbacks,c),c}finally{r==null||r.end();}});return a?yield context.with(a,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("get-embeddings.handler",o=>l(this,null,function*(){return yield d(o)}))})):yield d()})}var tt=z.object({model:z.custom(),data:z.any(),headers:z.record(z.string()),query:z.record(z.string()).optional()}),ao=z.object({request:z.any(),providerRequest:z.object({url:z.string().url(),headers:z.record(z.string()),data:z.any()}),providerResponse:z.any(),transformedResponse:z.optional(ChatResponse)});function rt(s,t,a){return l(this,null,function*(){let e=h.getLogger(),d=r=>l(this,null,function*(){e==null||e.debug("handleProxyCompleteChat invoked"),e==null||e.debug("handleProxyCompleteChat request: ",{request:s});let o=tt.parse(s),i=context.active();try{o.headers=M(T({},o.headers),{source:"adaline.ai"});let m={url:yield o.model.getProxyCompleteChatUrl(o.data,o.headers,o.query),headers:yield o.model.getProxyCompleteChatHeaders(o.data,o.headers,o.query),data:o.data};e==null||e.debug("handleProxyCompleteChat providerRequest: ",{providerRequest:m});let n=yield t.post(m.url,m.data,m.headers,i);e==null||e.debug("handleProxyCompleteChat providerResponse: ",{providerResponse:n});let c;try{c=o.model.transformCompleteChatResponse(n.data);}catch(y){e==null||e.warn("handleProxyCompleteChat transformation error: ",{transformationError:y});}let p={request:{header:o.headers,data:o.data,query:o.query},providerRequest:m,providerResponse:n,transformedResponse:c};return e==null||e.debug("handleProxyCompleteChat response: ",{response:p}),r==null||r.setStatus({code:SpanStatusCode.OK}),p}catch(m){e==null||e.warn("handleProxyCompleteChat error: ",{error:m});let n;throw w.isHttpRequestError(m)||m instanceof g?n=m:n=$(m),n}finally{r==null||r.end();}});return a?yield context.with(a,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("proxy-complete-chat.handler",o=>l(this,null,function*(){return yield d(o)}))})):yield d()})}var ot=z.object({model:z.custom(),data:z.any(),headers:z.record(z.string()),query:z.record(z.string()).optional()}),fo=z.object({request:z.any(),providerRequest:z.object({url:z.string().url(),headers:z.record(z.string()),data:z.any()}),providerResponse:z.any(),transformedResponse:z.optional(EmbeddingResponse)});function nt(s,t,a){return l(this,null,function*(){let e=h.getLogger(),d=r=>l(this,null,function*(){e==null||e.debug("handleProxyGetEmbeddings invoked"),e==null||e.debug("handleProxyGetEmbeddings request: ",{request:s});let o=ot.parse(s),i=context.active();try{let m={url:yield o.model.getGetEmbeddingsUrl(),headers:o.headers,data:o.data};m.headers=M(T({},m.headers),{source:"adaline.ai"});let n=T({},m);delete n.headers.host,delete n.headers["content-length"],e==null||e.debug("handleProxyGetEmbeddings providerRequest: ",{providerRequest:m});let c=yield t.post(n.url,n.data,n.headers,i);e==null||e.debug("handleProxyGetEmbeddings providerResponse: ",{providerResponse:c});let p;try{p=o.model.transformGetEmbeddingsResponse(c.data);}catch(f){e==null||e.warn("handleProxyGetEmbeddings transformation error: ",{transformationError:f});}let y={request:m,providerRequest:n,providerResponse:c,transformedResponse:p};return e==null||e.debug("handleProxyGetEmbeddings response: ",{response:y}),r==null||r.setStatus({code:SpanStatusCode.OK}),y}catch(m){e==null||e.warn("handleProxyGetEmbeddings error: ",{error:m});let n;throw w.isHttpRequestError(m)||m instanceof g?n=m:n=$(m),n}finally{r==null||r.end();}});return a?yield context.with(a,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("proxy-get-embeddings.handler",o=>l(this,null,function*(){return yield d(o)}))})):yield d()})}var it=z.object({model:z.custom(),data:z.any(),headers:z.record(z.string()),query:z.record(z.string()).optional()}),Po=z.object({request:z.any(),providerRequest:z.object({url:z.string().url(),headers:z.record(z.string()),data:z.any()}),providerResponse:z.any(),transformedResponse:z.array(PartialChatResponse).optional()});function ct(s,t,a){return Q(this,null,function*(){let e=h.getLogger(),d=function(r){return Q(this,null,function*(){var m,n,c;e==null||e.debug("handleProxyStreamChat invoked"),e==null||e.debug("handleProxyStreamChat request: ",{request:s});let o=context.active(),i=it.parse(s);try{i.headers=M(T({},i.headers),{source:"adaline.ai"});let S={url:yield new b(i.model.getProxyStreamChatUrl(i.data,i.headers,i.query)),headers:yield new b(i.model.getProxyStreamChatHeaders(i.data,i.headers,i.query)),data:i.data};e==null||e.debug("handleProxyStreamChat providerRequest: ",{providerRequest:S});let F="";try{for(var O=N(t.stream(S.url,"post",S.data,S.headers,void 0,o)),C,j,J;C=!(j=yield new b(O.next())).done;C=!1){let x=j.value;let q=[];try{try{for(var p=N(i.model.transformProxyStreamChatResponseChunk(x,F,i.data,i.headers,i.query)),y,f,U;y=!(f=yield new b(p.next())).done;y=!1){let z=f.value;F=z.buffer;let X=((n=(m=z.partialResponse)==null?void 0:m.partialMessages)==null?void 0:n.length)>0,pe=((c=z.partialResponse)==null?void 0:c.usage)!=null;(X||pe)&&q.push(z.partialResponse);}}catch(f){U=[f];}finally{try{y&&(f=p.return)&&(yield new b(f.call(p)));}finally{if(U)throw U[0]}}}catch(z){e==null||e.warn("handleProxyStreamChat transformation error",{transformationError:z}),q=void 0;}let V={request:{header:i.headers,data:i.data,query:i.query},providerRequest:S,providerResponse:x,transformedResponse:q};e==null||e.debug("handleProxyStreamChat streamResponse: ",{streamResponse:V}),yield V;}}catch(j){J=[j];}finally{try{C&&(j=O.return)&&(yield new b(j.call(O)));}finally{if(J)throw J[0]}}r==null||r.setStatus({code:SpanStatusCode.OK});}catch(S){e==null||e.warn("handleProxyStreamChat error: ",{error:S});let F;throw w.isHttpRequestError(S)||S instanceof g?F=S:F=$(S),F}finally{r==null||r.end();}})};return a?yield*I(yield new b(context.with(a,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("proxy-stream-chat.handler",o=>l(this,null,function*(){return yield d(o)}))})))):yield*I(d())})}var ut=z.object({model:z.custom(),config:Config(),messages:z.array(Message()),tools:z.array(Tool()).optional(),customHeaders:z.record(z.string()).optional(),callbacks:z.array(z.custom()).nonempty().optional(),metadataForCallbacks:z.any().optional(),abortSignal:z.instanceof(AbortSignal).optional()}),No=z.object({request:z.object({config:Config(),messages:z.array(Message()),tools:z.array(Tool()).optional()}),response:PartialChatResponse,metadataForCallbacks:z.any().optional(),provider:z.object({request:z.any(),response:z.any()})});function ht(s,t,a){return Q(this,null,function*(){let e=h.getLogger(),d=function(r){return Q(this,null,function*(){var c,p,y;e==null||e.debug("handleStreamChat invoked"),e==null||e.debug("handleStreamChat request: ",{request:s});let o=ut.parse(s),i=s.callbacks||[],m=context.active(),n={config:o.config,messages:o.messages,tools:o.tools};try{L(i,"onStreamStart",s.metadataForCallbacks);let x={url:yield new b(o.model.getStreamChatUrl(o.config,o.messages,o.tools)),headers:yield new b(o.model.getStreamChatHeaders(o.config,o.messages,o.tools)),data:yield new b(o.model.getStreamChatData(o.config,o.messages,o.tools))};v()||(x.headers=M(T({},x.headers),{source:"adaline.ai"})),o.customHeaders&&(x.headers=T(T({},x.headers),o.customHeaders)),e==null||e.debug("handleStreamChat providerRequest: ",{providerRequest:x});let q="",V=!0;try{for(var j=N(t.stream(x.url,"post",x.data,x.headers,{abortSignal:s.abortSignal},m)),J,S,F;J=!(S=yield new b(j.next())).done;J=!1){let z=S.value;try{for(var f=N(o.model.transformStreamChatResponseChunk(z,q)),U,O,C;U=!(O=yield new b(f.next())).done;U=!1){let X=O.value;q=X.buffer;let pe=((p=(c=X.partialResponse)==null?void 0:c.partialMessages)==null?void 0:p.length)>0,bt=((y=X.partialResponse)==null?void 0:y.usage)!=null;if(pe||bt){let me={request:n,response:X.partialResponse,metadataForCallbacks:s.metadataForCallbacks,provider:{request:x,response:z}};L(i,V?"onStreamFirstResponse":"onStreamNewResponse",s.metadataForCallbacks,me),V&&(V=!1),e==null||e.debug("handleStreamChat streamResponse: ",{streamResponse:me}),yield me;}}}catch(O){C=[O];}finally{try{U&&(O=f.return)&&(yield new b(O.call(f)));}finally{if(C)throw C[0]}}}}catch(S){F=[S];}finally{try{J&&(S=j.return)&&(yield new b(S.call(j)));}finally{if(F)throw F[0]}}r==null||r.setStatus({code:SpanStatusCode.OK}),L(i,"onStreamEnd",s.metadataForCallbacks);}catch(x){e==null||e.warn("handleStreamChat error: ",{error:x});let q;throw w.isHttpRequestError(x)||x instanceof g?q=x:q=$(x),L(i,"onStreamError",s.metadataForCallbacks,q),q}finally{r==null||r.end();}})};return a?yield*I(yield new b(context.with(a,()=>l(this,null,function*(){return yield R.getTracer().startActiveSpan("stream-chat.handler",o=>l(this,null,function*(){return yield d(o)}))})))):yield*I(d())})}var be=class{constructor(t={}){var e,d,r,o,i,m,n;if(!t.dangerouslyAllowBrowser&&v())throw new g("It looks like you're running in a browser-like environment.         This is disabled by default, as it risks exposing your provider secrets to attackers.         If you understand the risks and have appropriate mitigation in place,         you can set the `dangerouslyAllowBrowser` option to `true`.");this.options=Qe.parse(t),h.setLogger(t.logger),this.logger=t.logger,this.analytics=de.getAnalyticsRecorder(this.options.enableAnalytics===void 0?!0:this.options.enableAnalytics),R.setTracer((e=t.telemetry)==null?void 0:e.tracer),this.tracer=R.getTracer(),R.setMeter((d=t.telemetry)==null?void 0:d.meter),this.meter=R.getMeter();let a={maxConcurrentTasks:((r=this.options.queueOptions)==null?void 0:r.maxConcurrentTasks)||4,retryCount:((o=this.options.queueOptions)==null?void 0:o.retryCount)||3,retry:((i=this.options.queueOptions)==null?void 0:i.retry)||{initialDelay:1e3,exponentialFactor:2},timeout:((m=this.options.queueOptions)==null?void 0:m.timeout)||12e4};this.queues={completeChat:new Y(a),getEmbeddings:new Y(a),proxyCompleteChat:new Y(a),proxyGetEmbeddings:new Y(a)},this.options.enableProxyAgent=this.options.enableProxyAgent===void 0?!0:this.options.enableProxyAgent,this.httpClient=t.httpClient||new re({timeoutInMilliseconds:a.timeout*.9,enableProxyAgent:this.options.enableProxyAgent}),this.caches={completeChat:t.completeChatCache||new te,getEmbeddings:t.getEmbeddingsCache||new te},(n=this.logger)==null||n.debug("gateway initialized");}completeChat(t){return l(this,null,function*(){var d,r;(d=this.logger)==null||d.info("gateway.completeChat invoked"),(r=this.logger)==null||r.debug("request: ",{request:t});let a=ee.parse(t),e=a.model.modelSchema.name;return yield this.tracer.startActiveSpan("complete-chat",o=>l(this,null,function*(){return o.setAttribute("modelName",e),new Promise((i,m)=>{var c;let n={id:v4(),request:a,cache:this.caches.completeChat,resolve:p=>{this.analytics.record("completeChat","success",{modelName:e,usage:p.response.usage||{}}),i(p);},reject:p=>{console.log("completeChat error",p),this.analytics.record("completeChat","error",{modelName:e}),m(p);},execute:this.executeCompleteChat.bind(this),telemetryContext:context.active()};this.queues.completeChat.enqueue(n),(c=this.logger)==null||c.debug(`gateway.completeChat task enqueued, id: ${n.id}`);})}))})}executeCompleteChat(t,a){return l(this,null,function*(){var d,r,o,i;(d=this.logger)==null||d.debug("gateway.executeCompleteChat invoked");let e=ee.parse(t);return Ke({cache:this.caches.completeChat,model:e.model,config:e.config,messages:e.messages,tools:e.tools,enableCache:(o=(r=e.options)==null?void 0:r.enableCache)!=null?o:!0,callbacks:this.options.completeChatCallbacks,metadataForCallbacks:(i=e.options)==null?void 0:i.metadataForCallbacks},this.httpClient,a)})}streamChat(t){return Q(this,null,function*(){var i,m,n,c;(i=this.logger)==null||i.info("gateway.streamChat invoked"),(m=this.logger)==null||m.debug("request: ",{request:t});let a=Ie.parse(t),e=a.model.modelSchema.name,d="success",r=this.tracer.startSpan("stream-chat"),o=trace.setSpan(context.active(),r);try{return r.setAttribute("modelName",e),yield*I(yield new b(context.with(o,()=>l(this,null,function*(){var p;return ht({model:a.model,config:a.config,messages:a.messages,tools:a.tools,callbacks:this.options.streamChatCallbacks,metadataForCallbacks:(p=a.options)==null?void 0:p.metadataForCallbacks,abortSignal:a.abortSignal},this.httpClient,o)}))))}catch(p){throw d="error",r.setStatus({code:SpanStatusCode.ERROR,message:"stream failed"}),(n=this.logger)==null||n.error("gateway.streamChat error: ",{error:p}),p instanceof g?p:new g(p==null?void 0:p.message,500,(c=p==null?void 0:p.response)==null?void 0:c.data)}finally{this.analytics.record("streamChat",d,{modelName:e}),r.end();}})}getEmbeddings(t){return l(this,null,function*(){var d,r;(d=this.logger)==null||d.info("gateway.getEmbeddings invoked"),(r=this.logger)==null||r.debug("request: ",{request:t});let a=he.parse(t),e=a.model.modelSchema.name;return yield this.tracer.startActiveSpan("get-embeddings",o=>l(this,null,function*(){return o.setAttribute("modelName",e),new Promise((i,m)=>{var c;let n={id:v4(),request:a,cache:this.caches.getEmbeddings,resolve:p=>{this.analytics.record("getEmbeddings","success",{modelName:e,usage:p.response.usage||{}}),i(p);},reject:p=>{this.analytics.record("getEmbeddings","error",{modelName:e}),m(p);},execute:this.executeGetEmbeddings.bind(this),telemetryContext:context.active()};this.queues.getEmbeddings.enqueue(n),(c=this.logger)==null||c.debug(`gateway.getEmbeddings task enqueued, id: ${n.id}`);})}))})}executeGetEmbeddings(t,a){return l(this,null,function*(){var d,r,o,i;(d=this.logger)==null||d.debug("gateway.executeGetEmbeddings invoked");let e=he.parse(t);return et({cache:this.caches.getEmbeddings,model:e.model,config:e.config,embeddingRequests:e.embeddingRequests,enableCache:(o=(r=e.options)==null?void 0:r.enableCache)!=null?o:!0,callbacks:this.options.getEmbeddingsCallbacks,metadataForCallbacks:(i=e.options)==null?void 0:i.metadataForCallbacks},this.httpClient,a)})}proxyCompleteChat(t){return l(this,null,function*(){var d,r;(d=this.logger)==null||d.info("gateway.proxyCompleteChat invoked"),(r=this.logger)==null||r.debug("request: ",{request:t});let a=Ce.parse(t),e=a.model.modelSchema.name;return yield this.tracer.startActiveSpan("proxy-complete-chat",o=>l(this,null,function*(){return o.setAttribute("modelName",e),new Promise((i,m)=>{var c;let n={id:v4(),request:a,resolve:p=>{var y;this.analytics.record("proxyCompleteChat","success",{modelName:e,usage:((y=p.transformedResponse)==null?void 0:y.usage)||{}}),i(p);},reject:p=>{console.log("proxyCompleteChat error",p),this.analytics.record("proxyCompleteChat","error",{modelName:e}),m(p);},execute:this.executeProxyCompleteChat.bind(this),telemetryContext:context.active()};this.queues.proxyCompleteChat.enqueue(n),(c=this.logger)==null||c.debug(`gateway.proxyCompleteChat task enqueued, id: ${n.id}`);})}))})}executeProxyCompleteChat(t,a){return l(this,null,function*(){var d;(d=this.logger)==null||d.debug("gateway.executeCompleteChat invoked");let e=Ce.parse(t);return rt({model:e.model,data:e.data,headers:e.headers,query:e.query},this.httpClient,a)})}proxyStreamChat(t){return Q(this,null,function*(){var i,m,n,c;(i=this.logger)==null||i.info("gateway.proxyStreamChat invoked"),(m=this.logger)==null||m.debug("proxyStreamChat request: ",{request:t});let a=$e.parse(t),e=a.model.modelSchema.name,d="success",r=this.tracer.startSpan("proxy-stream-chat"),o=trace.setSpan(context.active(),r);try{return r.setAttribute("modelName",e),yield*I(yield new b(context.with(o,()=>l(this,null,function*(){return ct({model:a.model,data:a.data,headers:a.headers,query:a.query},this.httpClient,o)}))))}catch(p){throw d="error",r.setStatus({code:SpanStatusCode.ERROR,message:"proxy stream failed"}),(n=this.logger)==null||n.error("gateway.proxyStreamChat error: ",{error:p}),p instanceof g?p:new g(p==null?void 0:p.message,500,(c=p==null?void 0:p.response)==null?void 0:c.data)}finally{this.analytics.record("proxyStreamChat",d,{modelName:e}),r.end();}})}proxyGetEmbeddings(t){return l(this,null,function*(){var d,r;(d=this.logger)==null||d.info("gateway.proxyGetEmbeddings invoked"),(r=this.logger)==null||r.debug("request: ",{request:t});let a=fe.parse(t),e=a.model.modelSchema.name;return yield this.tracer.startActiveSpan("proxy-get-embeddings",o=>l(this,null,function*(){return o.setAttribute("modelName",e),new Promise((i,m)=>{var c;let n={id:v4(),request:a,resolve:p=>{var y;this.analytics.record("proxyGetEmbeddings","success",{modelName:e,usage:((y=p.transformedResponse)==null?void 0:y.usage)||{}}),i(p);},reject:p=>{this.analytics.record("proxyGetEmbeddings","error",{modelName:e}),m(p);},execute:this.executeProxyGetEmbeddings.bind(this),telemetryContext:context.active()};this.queues.proxyGetEmbeddings.enqueue(n),(c=this.logger)==null||c.debug(`gateway.proxyGetEmbeddings task enqueued, id: ${n.id}`);})}))})}executeProxyGetEmbeddings(t,a){return l(this,null,function*(){var d;(d=this.logger)==null||d.debug("gateway.executeProxyGetEmbeddings invoked");let e=fe.parse(t);return nt({model:e.model,headers:e.headers,data:e.data,query:e.query},this.httpClient,a)})}static getChatUsageCost(t){let a=je.parse(t);return Be({model:a.model,chatModelPrice:a.chatModelPrice,chatUsage:a.chatUsage})}};be.GatewayError=g;var Ds=z.object({chatUsage:z.custom(),chatModelPrice:z.custom().optional(),model:z.custom().optional()}).refine(s=>s.chatModelPrice!==void 0!=(s.model!==void 0),{message:"Exactly one of chatModelPrice or model must be provided, not both.",path:["chatModelPrice","model"]}),Vs=z.object({cost:z.number(),currency:z.string(),pricingModel:z.custom(),usageTokens:z.custom()});

export { de as AnalyticsManager, Ve as CompleteChatHandlerRequest, Rr as CompleteChatHandlerResponse, Pe as ConsoleLogger, be as Gateway, g as GatewayError, Te as GatewayTelemetryError, Ds as GetChatUsageCostHandlerRequest, Vs as GetChatUsageCostHandlerResponse, Je as GetEmbeddingsHandlerRequest, $r as GetEmbeddingsHandlerResponse, B as HttpClientError, w as HttpRequestError, re as IsomorphicHttpClient, te as LRUCache, h as LoggerManager, ne as NoOpAnalytics, ie as PostAnalytics, tt as ProxyCompleteChatHandlerRequest, ao as ProxyCompleteChatHandlerResponse, ot as ProxyGetEmbeddingsHandlerRequest, fo as ProxyGetEmbeddingsHandlerResponse, it as ProxyStreamChatHandlerRequest, Po as ProxyStreamChatHandlerResponse, Se as QueueOptions, oe as QueueTaskTimeoutError, Y as SimpleQueue, ut as StreamChatHandlerRequest, No as StreamChatHandlerResponse, R as TelemetryManager, Ke as handleCompleteChat, Be as handleGetChatUsageCost, et as handleGetEmbeddings, rt as handleProxyCompleteChat, nt as handleProxyGetEmbeddings, ct as handleProxyStreamChat, ht as handleStreamChat };
//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map